{{#if config.analytics.on }}


<script type="text/javascript">

  window.analytics=window.analytics||[],window.analytics.methods=["identify","group","track","page","pageview","alias","ready","on","once","off","trackLink","trackForm","trackClick","trackSubmit"],window.analytics.factory=function(t){return function(){var a=Array.prototype.slice.call(arguments);return a.unshift(t),window.analytics.push(a),window.analytics}};for(var i=0;i<window.analytics.methods.length;i++){var key=window.analytics.methods[i];window.analytics[key]=window.analytics.factory(key)}window.analytics.load=function(t){if(!document.getElementById("analytics-js")){var a=document.createElement("script");a.type="text/javascript",a.id="analytics-js",a.async=!0,a.src=("https:"===document.location.protocol?"https://":"http://")+"cdn.segment.io/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(a,n)}},window.analytics.SNIPPET_VERSION="2.0.9",
  window.analytics.load("{{config.analytics.segmentio.writekey}}");


  window.analytics.ready(function() {

    if (!window.bindTracking)
      window.bindTracking = function() {};

    var mixId = mixpanel.get_distinct_id()      

{{#if authenticated}}
    var email = '{{ user.email }}';
    var anonymousId = null;
{{else}}
    var email = null;  
    var anonymousId = '{{ user.sessionID }}';
{{/if}}

    console.log('userEmail', email, 'mixId', mixId, 'anonymousId', anonymousId)

    var ident = function() {
      console.log('identify', email || anonymousId)  //-- could be from a different session.
      window.analytics.identify(email || anonymousId, { id: email || anonymousId }, bindTracking);
    }

    
    // If they're signed in
    if (email && mixId != email) ident()
      
    // If they didn't already identify their email and log out  
    else if (mixId.indexOf("@") == -1 && anonymousId != mixId) 
    {      
      mixpanel.alias(anonymousId) 
      setTimeout(ident,200)      
    }
  });

</script>

{{else}}

<script type="text/javascript">
  window.analytics = false;
</script>

{{/if}}
