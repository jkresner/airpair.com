<!-- This is the chat widget directive template -->
<section class="main" ng-show="corechat.selfmember.loggedIn && corechat.getMembersByRoleFlag().admin">
  <audio id="chatAudio" src="/static/audio/message.wav"></audio>
  <header>
    <a class="icon" track-click="chatNav" class="{icon: !corechat.activeRoomId, 'icon-back': corechat.activeRoomId}">
      <img id="chatNavToggle" track-click="chatNav" data="{{ toggleAction }}" track-click-if="!session._id" ng-click="corechat.leaveActiveRoom()" ng-src="{{corechat.activeRoomId? '/static/img/css/chat/chat-back.png': '/static/img/css/chat/toggle.png'}}" />
      <i ng-show="corechat.selfmember.notificationsCount > 0">{{corechat.selfmember.notificationsCount}}</i>
    </a>
    <span ng-if="corechat.activeRoomId">
      {{corechat.activeRoom.info.name || "Anonymous User"}}
    </span>
    <span ng-show="!corechat.activeRoomId">
      All Chats
    </span>
  </header>

  <!-- connected -->
  <div ng-if="corechat.selfmember.loggedIn">
  
    <!-- list out rooms/conversations when activeRoom is empty -->
    <div ng-if="!corechat.activeRoom">
  
      <div id="roomList">
  
        <!-- don't show dupe admins in user rooms -->
        <div class="item" ng-repeat="admin in corechat.getMembersByRole('admin')" ng-click="corechat.setActiveRoomAsMember(admin)" ng-hide="admin.hasChat || admin.id == corechat.selfmember.id">
          {{admin.hasChat}}
          <div class="left">
            <div class="onlineDot" ng-show="admin.status != 'offline'">&nbsp;</div>
            <img class="avatar" ng-src="{{admin.avatar || '/static/img/css/sidenav/default-mario.png'}}" />
          </div>
          <div class="right">
            <b>{{admin.name}}</b><br />
            {{message.body}}
          </div>
        </div>
  
        <!-- members -->
        <div class="item" ng-repeat="(roomId, room) in corechat.selfmember.rooms" ng-click="corechat.setActiveRoom(roomId)" ng-class="{unread: corechat.selfmember.notificationsCountByRoom[roomId] > 0, active: corechat.lastActiveRoom == roomId }">
          <div class="left">
            <div class="onlineDot" ng-show="room.info.status != 'offline'">&nbsp;</div>
            <img class="avatar" ng-src="{{room.info.avatar || '/static/img/css/sidenav/default-mario.png'}}" />
          </div>
          <div class="right" member-info="{{message.from}}">
            <b>{{room.info.name || "Anonymous User"}}</b><br />{{message.body}}
            {{room.history[room.history.length-1].body}}<br/>
            <i class="time" am-time-ago="room.history[room.history.length-1].timestamp"></i>
          </div>
        </div>
      </div>
  
    </div>
  
  
    <!-- list out messages when in a room -->
    <div ng-show="corechat.activeRoom" id="chatContainer">
      <!-- container for overflow -->
      <div id="chatHeader">
        <img id="chatAvatar" ng-src="{{corechat.activeRoom.info.avatar || '/static/img/css/sidenav/default-mario.png'}}" />
        <div id="chatSubtitle"></div>
        <div id="chatStatus">{{corechat.activeRoom.info.status}}</div>
      </div>
      <div id="chatMessages" scroll-glue="true">
        <!-- message item here -->
        <div class="item" ng-repeat="message in corechat.activeRoom.history" member-info="{{message.from}}" ng-class="{fromOther: member.id !== corechat.selfmember.id}">
          <div class="left">
            <div class="onlineDot" ng-show="member.status != 'offline'">&nbsp;</div>
            <img class="avatar" ng-src="{{member.avatar || '/static/img/css/sidenav/default-mario.png'}}" />
          </div>
          <div class="right"> 
            <!-- <b>{{member.name || "Anonymous User"}}:</b><br /> -->
            {{message.body}}<br/>
            <i class="time" timestamp="message.timestamp" ng-if="$last"></i>
          </div>
        </div>
      </div>
  
      <!-- input mechanism for new message -->
      <div id="chatInputWrapper">
        <form name="newMessage">
          <input id="chatInput" type="text" ng-model="newMessage.body" placeholder="ask a question"/>
          <button type="submit" ng-show="newMessage.body" ng-click="corechat.sendMessageToRoom(corechat.activeRoomId, newMessage.body); newMessage.body=''">Send</button>
        </form>
      </div>
    </div>
  
  </div>
</section>